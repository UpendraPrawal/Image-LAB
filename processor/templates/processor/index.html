{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ImageLab ‚Äî Vision Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0a0a0f;
  --ink1: #111118;
  --ink2: #1a1a24;
  --ink3: #252534;
  --ink4: #32324a;
  --border: rgba(255,255,255,0.07);
  --border-hi: rgba(255,255,255,0.14);
  --text: #f0efff;
  --text2: #9998bb;
  --text3: #5f5e80;
  --gold: #f5c842;
  --gold2: #e8a820;
  --coral: #ff6b6b;
  --mint: #4dffd2;
  --lav: #c4b5fd;
  --sky: #67e8f9;
  --sidebar-w: 272px;
  --header-h: 64px;
  --ease: cubic-bezier(0.16,1,0.3,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'Outfit',sans-serif;background:var(--ink);color:var(--text);min-height:100vh;overflow-x:hidden}

/* BACKGROUND */
.bg-mesh{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.bg-mesh::before{content:'';position:absolute;width:900px;height:900px;top:-300px;left:-200px;background:radial-gradient(circle,rgba(90,70,190,0.1) 0%,transparent 65%);animation:floatA 22s ease-in-out infinite}
.bg-mesh::after{content:'';position:absolute;width:700px;height:700px;bottom:-200px;right:-150px;background:radial-gradient(circle,rgba(245,200,66,0.07) 0%,transparent 65%);animation:floatB 28s ease-in-out infinite}
.bg-grid{position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(rgba(255,255,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.025) 1px,transparent 1px);background-size:44px 44px}
@keyframes floatA{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(50px,30px) scale(1.08)}66%{transform:translate(-30px,60px) scale(0.93)}}
@keyframes floatB{0%,100%{transform:translate(0,0)}50%{transform:translate(-70px,-50px) scale(1.12)}}

/* HEADER */
header{position:fixed;top:0;left:0;right:0;z-index:200;height:var(--header-h);display:flex;align-items:center;padding:0 24px;gap:0;background:rgba(10,10,15,0.75);backdrop-filter:blur(28px) saturate(1.8);border-bottom:1px solid var(--border)}
.logo{display:flex;align-items:center;gap:6px;text-decoration:none;user-select:none}
.logo-name{font-family:'Instrument Serif',serif;font-size:1.5rem;letter-spacing:-0.5px}
.logo-img{color:var(--text)}
.logo-lab{color:var(--gold);font-style:italic}
.logo-pulse{width:7px;height:7px;background:var(--mint);border-radius:50%;animation:pulse 2.2s ease-in-out infinite;flex-shrink:0;margin-top:-10px}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.3;transform:scale(0.7)}}
.header-chips{display:flex;gap:6px;margin-left:20px}
.chip{font-family:'DM Mono',monospace;font-size:0.58rem;letter-spacing:1px;padding:3px 10px;border-radius:100px;border:1px solid}
.chip-cv{border-color:rgba(77,255,210,0.3);color:var(--mint);background:rgba(77,255,210,0.05)}
.chip-np{border-color:rgba(245,200,66,0.3);color:var(--gold);background:rgba(245,200,66,0.05)}
.chip-dj{border-color:rgba(196,181,253,0.3);color:var(--lav);background:rgba(196,181,253,0.05)}
.header-right{margin-left:auto;display:flex;align-items:center;gap:10px}
.file-chip{font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--mint);background:rgba(77,255,210,0.07);border:1px solid rgba(77,255,210,0.2);padding:4px 12px;border-radius:100px;display:none;align-items:center;gap:6px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-chip.show{display:flex}
.file-chip-dot{width:5px;height:5px;background:var(--mint);border-radius:50%;flex-shrink:0;animation:pulse 1.5s infinite}

/* SHELL */
.shell{display:grid;grid-template-columns:var(--sidebar-w) 1fr;padding-top:var(--header-h);min-height:100vh;position:relative;z-index:1}

/* SIDEBAR */
.sidebar{position:sticky;top:var(--header-h);height:calc(100vh - var(--header-h));background:rgba(15,15,22,0.85);backdrop-filter:blur(20px);border-right:1px solid var(--border);display:flex;flex-direction:column}
.sb-scroll{flex:1;overflow-y:auto;padding:18px 12px;scrollbar-width:thin;scrollbar-color:var(--ink4) transparent}
.sb-scroll::-webkit-scrollbar{width:3px}
.sb-scroll::-webkit-scrollbar-thumb{background:var(--ink4);border-radius:3px}
.sb-group-label{font-family:'DM Mono',monospace;font-size:0.55rem;letter-spacing:3px;text-transform:uppercase;color:var(--text3);padding:0 10px;margin:18px 0 6px}
.sb-group-label:first-child{margin-top:0}

/* Op buttons */
.op-btn{width:100%;display:flex;align-items:center;gap:11px;padding:9px 11px;background:transparent;border:1px solid transparent;border-radius:10px;cursor:pointer;text-align:left;transition:all 0.22s var(--ease);margin-bottom:2px;position:relative;overflow:hidden}
.op-btn::after{content:'';position:absolute;left:0;top:15%;bottom:15%;width:3px;background:var(--gold);border-radius:0 3px 3px 0;transform:scaleY(0);transition:transform 0.2s var(--ease);box-shadow:0 0 10px rgba(245,200,66,0.6)}
.op-btn:hover{background:rgba(255,255,255,0.03);border-color:var(--border)}
.op-btn.active{background:rgba(245,200,66,0.07);border-color:rgba(245,200,66,0.2)}
.op-btn.active::after{transform:scaleY(1)}
.op-icon-box{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:0.95rem;flex-shrink:0;background:var(--ink2);border:1px solid var(--border);transition:all 0.22s}
.op-btn:hover .op-icon-box,.op-btn.active .op-icon-box{background:rgba(245,200,66,0.1);border-color:rgba(245,200,66,0.25)}
.op-txt{flex:1;min-width:0}
.op-name{font-size:0.78rem;font-weight:500;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:color 0.2s}
.op-btn:hover .op-name{color:var(--text)}
.op-btn.active .op-name{color:var(--gold);font-weight:600}
.op-tag{font-family:'DM Mono',monospace;font-size:0.55rem;background:var(--ink2);color:var(--text3);padding:1px 7px;border-radius:100px;flex-shrink:0;border:1px solid var(--border);transition:all 0.2s}
.op-btn.active .op-tag{background:rgba(245,200,66,0.12);color:var(--gold);border-color:rgba(245,200,66,0.25)}

/* Sidebar footer */
.sb-foot{padding:12px;border-top:1px solid var(--border);background:rgba(10,10,15,0.6)}
.sb-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.sb-stat{background:var(--ink2);border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center}
.sb-stat-val{font-family:'DM Mono',monospace;font-size:1.05rem;color:var(--gold)}
.sb-stat-lbl{font-size:0.58rem;color:var(--text3);margin-top:1px;letter-spacing:0.3px}

/* WORKSPACE */
.workspace{padding:24px 28px;display:flex;flex-direction:column;gap:20px}

/* PANELS */
.panel{background:rgba(17,17,26,0.72);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:14px;overflow:hidden;transition:border-color 0.3s}
.panel:hover{border-color:var(--border-hi)}
.panel-bar{display:flex;align-items:center;gap:10px;padding:13px 18px;border-bottom:1px solid var(--border);background:rgba(255,255,255,0.015)}
.pbar-dots{display:flex;gap:5px}
.pd{width:8px;height:8px;border-radius:50%}
.pd-r{background:#ff5f57}.pd-y{background:#febc2e}.pd-g{background:#28c840}
.pbar-title{font-family:'DM Mono',monospace;font-size:0.64rem;letter-spacing:1.5px;color:var(--text3);text-transform:uppercase;margin-left:4px}
.pbar-badge{margin-left:auto;font-family:'DM Mono',monospace;font-size:0.58rem;padding:3px 10px;border-radius:100px;border:1px solid var(--border);color:var(--text3)}

/* UPLOAD SECTION */
.upload-body{display:grid;grid-template-columns:1fr 360px;gap:18px;padding:22px}

.drop-zone{border:2px dashed rgba(255,255,255,0.09);border-radius:12px;padding:32px 20px;text-align:center;cursor:pointer;transition:all 0.3s var(--ease);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;min-height:210px;background:rgba(255,255,255,0.008);position:relative;overflow:hidden}
.drop-zone::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center, rgba(245,200,66,0.03) 0%,transparent 70%);opacity:0;transition:opacity 0.3s}
.drop-zone:hover,.drop-zone.drag-over{border-color:rgba(245,200,66,0.5);background:rgba(245,200,66,0.03)}
.drop-zone:hover::before,.drop-zone.drag-over::before{opacity:1}

.dz-ring{width:68px;height:68px;border-radius:50%;background:var(--ink2);border:2px solid rgba(255,255,255,0.07);display:flex;align-items:center;justify-content:center;font-size:1.7rem;position:relative;transition:all 0.3s}
.dz-ring::before{content:'';position:absolute;inset:-8px;border-radius:50%;border:1px dashed rgba(245,200,66,0.18);animation:spin 14s linear infinite}
.drop-zone:hover .dz-ring{background:rgba(245,200,66,0.08);border-color:rgba(245,200,66,0.35);box-shadow:0 0 28px rgba(245,200,66,0.12)}
@keyframes spin{to{transform:rotate(360deg)}}

.dz-title{font-size:1rem;font-weight:600;color:var(--text)}
.dz-sub{font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--text3)}
.dz-btn{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#09090e;border:none;padding:10px 22px;border-radius:100px;font-family:'Outfit',sans-serif;font-size:0.76rem;font-weight:700;cursor:pointer;transition:all 0.25s;box-shadow:0 4px 18px rgba(245,200,66,0.22)}
.dz-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(245,200,66,0.38)}
#file-input{display:none}

/* Preview card */
.prev-card{background:var(--ink2);border:1px solid var(--border);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
.prev-bar{padding:9px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.prev-lbl{font-family:'DM Mono',monospace;font-size:0.58rem;letter-spacing:1.5px;color:var(--mint)}
.prev-dims{font-family:'DM Mono',monospace;font-size:0.58rem;color:var(--text3)}
.prev-body{flex:1;display:flex;align-items:center;justify-content:center;padding:14px;min-height:160px}
#preview-img{max-width:100%;max-height:190px;object-fit:contain;border-radius:7px;display:none;cursor:zoom-in;animation:fadeIn 0.35s var(--ease)}
.prev-empty{display:flex;flex-direction:column;align-items:center;gap:7px;color:var(--text3);font-size:0.72rem}
.prev-empty-icon{font-size:2.2rem;opacity:0.25}
@keyframes fadeIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}

/* CONTROL SECTION */
.ctrl-body{padding:22px;display:none;flex-direction:column;gap:18px}
.ctrl-body.show{display:flex}
.hint-state{padding:36px 22px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--text3);font-size:0.82rem}
.hint-arrow{font-size:2rem;opacity:0.2;animation:leftRight 2s ease-in-out infinite}
@keyframes leftRight{0%,100%{transform:translateX(0)}50%{transform:translateX(-8px)}}

/* Op hero */
.op-hero{display:flex;align-items:center;gap:14px;padding:14px 18px;background:var(--ink2);border:1px solid var(--border);border-radius:12px}
.op-hero-icon{width:50px;height:50px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;background:linear-gradient(135deg,rgba(245,200,66,0.1),rgba(245,200,66,0.03));border:1px solid rgba(245,200,66,0.2);flex-shrink:0}
.op-hero-title{font-family:'Instrument Serif',serif;font-size:1.25rem;color:var(--text);letter-spacing:-0.3px}
.op-hero-desc{font-size:0.72rem;color:var(--text3);margin-top:2px}

/* Param grid */
.params-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:14px}
.param-card{background:var(--ink2);border:1px solid var(--border);border-radius:11px;padding:13px 15px;transition:border-color 0.2s}
.param-card:hover{border-color:var(--border-hi)}
.param-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.param-nm{font-size:0.7rem;font-weight:500;color:var(--text2)}
.param-val{font-family:'DM Mono',monospace;font-size:0.74rem;color:var(--gold);background:rgba(245,200,66,0.09);padding:2px 8px;border-radius:6px;border:1px solid rgba(245,200,66,0.18);min-width:42px;text-align:center}
input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;height:4px;background:var(--ink3);border-radius:100px;outline:none;cursor:pointer}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:15px;height:15px;border-radius:50%;background:var(--gold);border:2px solid var(--ink);box-shadow:0 0 8px rgba(245,200,66,0.5);cursor:pointer;transition:transform 0.2s}
input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.25)}
input[type="range"]::-moz-range-thumb{width:15px;height:15px;border-radius:50%;background:var(--gold);border:2px solid var(--ink);cursor:pointer}

/* No params notice */
.no-params{padding:12px 0;font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--text3);display:flex;align-items:center;gap:8px}

/* Run button */
.run-wrap{display:flex;gap:12px;align-items:center}
.run-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:10px;padding:14px 28px;background:linear-gradient(135deg,var(--gold) 0%,#f09b10 100%);color:#090910;border:none;border-radius:11px;font-family:'Outfit',sans-serif;font-size:0.87rem;font-weight:700;cursor:pointer;transition:all 0.28s var(--ease);box-shadow:0 4px 18px rgba(245,200,66,0.18);position:relative;overflow:hidden;letter-spacing:0.2px}
.run-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.18),transparent);transition:left 0.5s}
.run-btn:hover::before{left:100%}
.run-btn:hover{transform:translateY(-2px);box-shadow:0 8px 36px rgba(245,200,66,0.38)}
.run-btn:active{transform:translateY(0)}
.run-btn:disabled{opacity:0.32;cursor:not-allowed;transform:none;box-shadow:none}
.run-icon{font-size:1rem}
.run-hint{font-family:'DM Mono',monospace;font-size:0.6rem;color:var(--text3);max-width:160px;line-height:1.6;text-align:center}

/* RESULTS */
.results-panel{min-height:280px}
.loading-state{display:none;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:60px}
.loading-state.show{display:flex}
.spin-ring{width:52px;height:52px;border-radius:50%;border:3px solid var(--ink3);border-top-color:var(--gold);animation:spin 0.75s linear infinite}
.spin-txt{font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--gold);letter-spacing:2px}
.spin-dots::after{content:'';animation:dots 1.4s steps(4,end) infinite}
@keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}}

.results-body{padding:22px;display:none}
.results-body.show{display:block;animation:fadeIn 0.3s var(--ease)}

.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:55px;text-align:center}
.empty-orb{width:84px;height:84px;border-radius:50%;background:radial-gradient(circle,var(--ink2) 50%,transparent);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:2.2rem;position:relative}
.empty-orb::before{content:'';position:absolute;inset:-10px;border-radius:50%;border:1px dashed var(--border)}
.empty-title{font-family:'Instrument Serif',serif;font-size:1.15rem;color:var(--text2)}
.empty-body{font-size:0.77rem;color:var(--text3);max-width:280px;line-height:1.65}

/* ‚îÄ‚îÄ RESULT COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.r-section{margin-bottom:22px}
.r-heading{font-family:'DM Mono',monospace;font-size:0.6rem;letter-spacing:2.5px;text-transform:uppercase;color:var(--text3);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.r-heading::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--border),transparent)}

.img-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:13px}
.img-tile{background:var(--ink2);border:1px solid var(--border);border-radius:11px;overflow:hidden;transition:all 0.25s var(--ease);cursor:zoom-in}
.img-tile:hover{border-color:var(--border-hi);transform:translateY(-3px);box-shadow:0 10px 28px rgba(0,0,0,0.4)}
.img-lbl{padding:8px 12px;font-family:'DM Mono',monospace;font-size:0.58rem;letter-spacing:0.8px;color:var(--text3);border-bottom:1px solid var(--border)}
.img-lbl.gold{color:var(--gold)}.img-lbl.mint{color:var(--mint)}.img-lbl.coral{color:var(--coral)}.img-lbl.lav{color:var(--lav)}.img-lbl.sky{color:var(--sky)}
.img-tile img{width:100%;display:block;max-height:185px;object-fit:cover}

.data-tbl{background:var(--ink2);border:1px solid var(--border);border-radius:11px;overflow:hidden;font-family:'DM Mono',monospace}
.d-row{display:grid;grid-template-columns:210px 1fr;border-bottom:1px solid var(--border)}
.d-row:last-child{border-bottom:none}
.d-key{padding:10px 14px;font-size:0.65rem;color:var(--text3);background:rgba(0,0,0,0.15);border-right:1px solid var(--border);display:flex;align-items:center}
.d-val{padding:10px 14px;font-size:0.68rem;color:var(--mint);display:flex;align-items:center;flex-wrap:wrap;gap:6px}
.d-val.gold{color:var(--gold)}.d-val.coral{color:var(--coral)}

.plot-box{background:var(--ink2);border:1px solid var(--border);border-radius:11px;overflow:hidden}
.plot-box img{width:100%;display:block;cursor:zoom-in}

.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 9px;border-radius:100px;font-size:0.6rem;font-family:'DM Mono',monospace;font-weight:500}
.b-r{background:rgba(255,107,107,.1);color:var(--coral);border:1px solid rgba(255,107,107,.25)}
.b-g{background:rgba(77,255,210,.1);color:var(--mint);border:1px solid rgba(77,255,210,.25)}
.b-b{background:rgba(103,232,249,.1);color:var(--sky);border:1px solid rgba(103,232,249,.25)}
.b-y{background:rgba(245,200,66,.1);color:var(--gold);border:1px solid rgba(245,200,66,.25)}

.status-chip{display:inline-flex;align-items:center;gap:7px;padding:5px 14px;border-radius:100px;font-family:'DM Mono',monospace;font-size:0.63rem;margin-bottom:18px}
.chip-ok{background:rgba(77,255,210,.07);color:var(--mint);border:1px solid rgba(77,255,210,.22)}
.chip-err{background:rgba(255,107,107,.07);color:var(--coral);border:1px solid rgba(255,107,107,.22)}
.chip-dot{width:5px;height:5px;border-radius:50%;background:currentColor;flex-shrink:0}

.mx-wrap{background:var(--ink2);border:1px solid var(--border);border-radius:11px;padding:15px;overflow-x:auto}
.mx-lbl{font-family:'DM Mono',monospace;font-size:0.58rem;color:var(--text3);margin-bottom:9px}
.mx{border-collapse:collapse;font-family:'DM Mono',monospace;font-size:0.7rem}
.mx td{padding:6px 13px;border:1px solid var(--border);text-align:center;color:var(--gold)}
.mx.threshed td{color:var(--text3)}
.mx.threshed td.on{color:var(--mint)}

.face-grid{display:flex;flex-wrap:wrap;gap:13px}
.face-tile{background:var(--ink2);border:1px solid rgba(77,255,210,.22);border-radius:11px;overflow:hidden;box-shadow:0 0 16px rgba(77,255,210,.04)}
.face-tile-lbl{padding:7px 11px;font-family:'DM Mono',monospace;font-size:0.58rem;color:var(--mint);border-bottom:1px solid rgba(77,255,210,.15)}
.face-tile img{display:block;max-height:200px}
.no-face{padding:22px;text-align:center;background:rgba(255,107,107,.04);border:1px dashed rgba(255,107,107,.25);border-radius:11px;font-family:'DM Mono',monospace;font-size:0.75rem;color:var(--coral)}
.no-face span{display:block;font-size:0.62rem;color:var(--text3);margin-top:5px}

.err-box{background:rgba(255,107,107,.06);border:1px solid rgba(255,107,107,.22);border-radius:11px;padding:16px 20px;font-family:'DM Mono',monospace;font-size:0.76rem;color:var(--coral)}

/* LIGHTBOX */
.lightbox{position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.88);backdrop-filter:blur(18px);display:none;align-items:center;justify-content:center;padding:40px;cursor:zoom-out;animation:lbIn 0.22s}
.lightbox.show{display:flex}
@keyframes lbIn{from{opacity:0}to{opacity:1}}
.lightbox img{max-width:90vw;max-height:85vh;object-fit:contain;border-radius:11px;box-shadow:0 40px 80px rgba(0,0,0,.6);animation:lbImg 0.28s var(--ease)}
@keyframes lbImg{from{transform:scale(0.93)}to{transform:scale(1)}}

/* RESPONSIVE */
@media(max-width:900px){.shell{grid-template-columns:1fr}.sidebar{position:static;height:auto}.upload-body{grid-template-columns:1fr}.workspace{padding:14px;gap:14px}}
</style>
</head>
<body>

<div class="bg-mesh"></div>
<div class="bg-grid"></div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <img id="lightbox-img" src="" alt="">
</div>

<!-- HEADER -->
<header>
  <a class="logo" href="#">
    <span class="logo-name"><span class="logo-img">Image</span><span class="logo-lab">Lab</span></span>
    <div class="logo-pulse"></div>
  </a>
  <div class="header-chips">
    <span class="chip chip-cv">OpenCV</span>
    <span class="chip chip-np">NumPy</span>
    <span class="chip chip-dj">Django</span>
  </div>
  <div class="header-right">
    <div class="file-chip" id="file-chip">
      <div class="file-chip-dot"></div>
      <span id="file-name-disp">‚Äî</span>
    </div>
  </div>
</header>

<!-- SHELL -->
<div class="shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sb-scroll">
      <p class="sb-group-label">Operations</p>
      {% for key, op in operations.items %}
      <button class="op-btn" data-op="{{ key }}"
              onclick="selectOp('{{ key }}', this)">
        <span class="op-icon-box">{{ op.icon }}</span>
        <span class="op-txt">
          <span class="op-name">{{ op.label }}</span>
        </span>
        <span class="op-tag">{{ op.category }}</span>
      </button>
      {% endfor %}
    </div>
    <div class="sb-foot">
      <div class="sb-stats">
        <div class="sb-stat">
          <div class="sb-stat-val">9</div>
          <div class="sb-stat-lbl">Categories</div>
        </div>
        <div class="sb-stat">
          <div class="sb-stat-val">30+</div>
          <div class="sb-stat-lbl">Operations</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- WORKSPACE -->
  <main class="workspace">

    <!-- Upload Panel -->
    <div class="panel">
      <div class="panel-bar">
        <div class="pbar-dots"><div class="pd pd-r"></div><div class="pd pd-y"></div><div class="pd pd-g"></div></div>
        <span class="pbar-title">Image Input</span>
        <span class="pbar-badge">PNG ¬∑ JPG ¬∑ BMP ¬∑ TIFF ¬∑ WebP</span>
      </div>
      <div class="upload-body">
        <div class="drop-zone" id="drop-zone"
             onclick="document.getElementById('file-input').click()"
             ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
          <div class="dz-ring">üñºÔ∏è</div>
          <div>
            <div class="dz-title">Drop your image here</div>
            <div class="dz-sub" style="margin-top:4px">or click to browse</div>
          </div>
          <div class="dz-sub">PNG ¬∑ JPG ¬∑ BMP ¬∑ TIFF ¬∑ WebP ‚Äî max 10 MB</div>
          <button class="dz-btn" onclick="event.stopPropagation();document.getElementById('file-input').click()">Choose File</button>
          <input type="file" id="file-input" accept="image/*" onchange="handleFile(this)">
        </div>

        <div class="prev-card">
          <div class="prev-bar">
            <span class="prev-lbl">PREVIEW</span>
            <span class="prev-dims" id="prev-dims">‚Äî</span>
          </div>
          <div class="prev-body">
            <img id="preview-img" src="" alt="" onclick="openLightbox(this.src)">
            <div class="prev-empty" id="prev-empty">
              <div class="prev-empty-icon">üì∑</div>
              <div>No image loaded</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls Panel -->
    <div class="panel" id="ctrl-panel">
      <div class="panel-bar">
        <div class="pbar-dots"><div class="pd pd-r"></div><div class="pd pd-y"></div><div class="pd pd-g"></div></div>
        <span class="pbar-title">Configuration</span>
      </div>

      <div class="hint-state" id="hint-state">
        <div class="hint-arrow">‚Üê</div>
        <div>Select an operation from the sidebar to configure and run</div>
      </div>

      <div class="ctrl-body" id="ctrl-body">
        <div id="op-hero-slot"></div>
        <div id="params-slot"></div>
        <div class="run-wrap">
          <button class="run-btn" id="run-btn" onclick="runProcess()" disabled>
            <span class="run-icon">‚ñ∂</span> Run Analysis
          </button>
          <div class="run-hint" id="run-hint">Upload an image &amp; select an operation</div>
        </div>
      </div>
    </div>

    <!-- Results Panel -->
    <div class="panel results-panel" id="results-panel">
      <div class="panel-bar">
        <div class="pbar-dots"><div class="pd pd-r"></div><div class="pd pd-y"></div><div class="pd pd-g"></div></div>
        <span class="pbar-title">Results</span>
        <span class="pbar-badge" id="res-badge">‚Äî</span>
      </div>
      <div class="loading-state" id="loading-state">
        <div class="spin-ring"></div>
        <div class="spin-txt">Processing<span class="spin-dots"></span></div>
      </div>
      <div class="results-body" id="results-body">
        <div class="empty-state">
          <div class="empty-orb">‚öóÔ∏è</div>
          <div class="empty-title">Awaiting Analysis</div>
          <div class="empty-body">Choose an operation, upload your image, configure any parameters, then hit Run.</div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
const OPS_DATA = {};
{% for key, op in operations.items %}
OPS_DATA['{{ key }}'] = { label:'{{ op.label }}', icon:'{{ op.icon }}', desc:'{{ op.desc }}', params:{{ op.params|safe }} };
{% endfor %}

let currentOp = null, selectedFile = null;

function selectOp(key, el) {
  currentOp = key;
  document.querySelectorAll('.op-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  const op = OPS_DATA[key];

  document.getElementById('hint-state').style.display = 'none';
  document.getElementById('ctrl-body').classList.add('show');

  document.getElementById('op-hero-slot').innerHTML = `
    <div class="op-hero">
      <div class="op-hero-icon">${op.icon}</div>
      <div>
        <div class="op-hero-title">${op.label}</div>
        <div class="op-hero-desc">${op.desc}</div>
      </div>
    </div>`;

  const slot = document.getElementById('params-slot');
  if (op.params && op.params.length) {
    slot.innerHTML = `<div class="params-grid">${op.params.map(p => {
      const mn=p.min??0, mx=p.max??100, st=p.step??1, dv=p.default??mn;
      return `<div class="param-card">
        <div class="param-hdr"><span class="param-nm">${p.label}</span><span class="param-val" id="v-${p.name}">${dv}</span></div>
        <input type="range" id="p-${p.name}" name="${p.name}" min="${mn}" max="${mx}" step="${st}" value="${dv}"
          oninput="document.getElementById('v-${p.name}').textContent=this.value">
      </div>`;
    }).join('')}</div>`;
  } else {
    slot.innerHTML = `<div class="no-params"><span style="opacity:.4">‚óÜ</span> No parameters ‚Äî runs with default settings</div>`;
  }
  syncRunBtn(); syncRunHint();
}

function handleFile(input) {
  if (!input.files[0]) return;
  selectedFile = input.files[0];
  const chip = document.getElementById('file-chip');
  const nm = selectedFile.name;
  document.getElementById('file-name-disp').textContent = nm.length>20 ? nm.slice(0,18)+'‚Ä¶' : nm;
  chip.classList.add('show');
  const r = new FileReader();
  r.onload = e => {
    const img = document.getElementById('preview-img');
    img.src = e.target.result;
    img.style.display = 'block';
    document.getElementById('prev-empty').style.display = 'none';
    const ti = new Image();
    ti.onload = () => { document.getElementById('prev-dims').textContent = `${ti.naturalWidth} √ó ${ti.naturalHeight}`; };
    ti.src = e.target.result;
  };
  r.readAsDataURL(selectedFile);
  const dz = document.getElementById('drop-zone');
  dz.style.borderColor = 'var(--mint)';
  setTimeout(() => { dz.style.borderColor = ''; }, 1100);
  syncRunBtn(); syncRunHint();
}

function onDragOver(e) { e.preventDefault(); document.getElementById('drop-zone').classList.add('drag-over'); }
function onDragLeave() { document.getElementById('drop-zone').classList.remove('drag-over'); }
function onDrop(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.remove('drag-over');
  if (e.dataTransfer.files[0]) {
    const dt = new DataTransfer(); dt.items.add(e.dataTransfer.files[0]);
    const inp = document.getElementById('file-input'); inp.files = dt.files; handleFile(inp);
  }
}

function syncRunBtn() { document.getElementById('run-btn').disabled = !(selectedFile && currentOp); }
function syncRunHint() {
  const h = document.getElementById('run-hint');
  if (!h) return;
  if (!currentOp && !selectedFile) h.textContent = 'Select operation + upload image';
  else if (!currentOp) h.textContent = 'Select an operation from the sidebar';
  else if (!selectedFile) h.textContent = 'Upload an image to enable';
  else h.textContent = `Ready ¬∑ ${OPS_DATA[currentOp].label}`;
}

async function runProcess() {
  if (!selectedFile || !currentOp) return;
  const loading = document.getElementById('loading-state');
  const body = document.getElementById('results-body');
  const badge = document.getElementById('res-badge');
  loading.classList.add('show');
  body.classList.remove('show');
  badge.textContent = 'Processing‚Ä¶'; badge.style.color = 'var(--gold)';
  document.getElementById('results-panel').scrollIntoView({ behavior:'smooth', block:'start' });

  const fd = new FormData();
  fd.append('image', selectedFile);
  fd.append('operation', currentOp);
  fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
  const op = OPS_DATA[currentOp];
  if (op && op.params) op.params.forEach(p => { const el=document.getElementById(`p-${p.name}`); if(el) fd.append(p.name, el.value); });

  const t0 = Date.now();
  try {
    const res = await fetch('/process/', { method:'POST', body:fd, headers:{'X-CSRFToken':'{{ csrf_token }}'} });
    const data = await res.json();
    const elapsed = ((Date.now()-t0)/1000).toFixed(2);
    if (data.success) {
      body.innerHTML = data.html;
      badge.textContent = `Done ¬∑ ${elapsed}s`; badge.style.color = 'var(--mint)';
      attachLightbox();
    } else {
      body.innerHTML = `<div class="err-box">‚ö† ${data.error || 'Unknown error'}</div>`;
      badge.textContent = 'Error'; badge.style.color = 'var(--coral)';
    }
  } catch(e) {
    body.innerHTML = `<div class="err-box">‚ö† Network error: ${e.message}</div>`;
    badge.textContent = 'Error'; badge.style.color = 'var(--coral)';
  }
  loading.classList.remove('show');
  body.classList.add('show');
}

function attachLightbox() {
  document.querySelectorAll('.img-tile img, .face-tile img, .plot-box img').forEach(img => {
    img.style.cursor = 'zoom-in';
    img.onclick = () => openLightbox(img.src);
  });
}
function openLightbox(src) { document.getElementById('lightbox-img').src=src; document.getElementById('lightbox').classList.add('show'); }
function closeLightbox() { document.getElementById('lightbox').classList.remove('show'); }
document.addEventListener('keydown', e => { if(e.key==='Escape') closeLightbox(); });
</script>
</body>
</html>
